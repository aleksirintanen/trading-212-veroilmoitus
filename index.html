<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading 212 Verolaskuri</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: radial-gradient(circle at top, #eef3ff 0%, #e6ecff 30%, #dbe5ff 55%, #cfdcff 100%);
            min-height: 100vh;
            padding: 28px;
            color: #172033;
        }

        .container {
            max-width: 1240px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 18px 55px rgba(25, 39, 74, 0.18);
            overflow: hidden;
            border: 1px solid rgba(107, 126, 255, 0.12);
        }

        .header {
            background: linear-gradient(120deg, #3d56cc 0%, #556fe1 48%, #6e5cd6 100%);
            color: white;
            padding: 36px 32px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.3em;
            margin-bottom: 8px;
            letter-spacing: 0.2px;
        }

        .header p {
            font-size: 1em;
            opacity: 0.92;
        }

        .content {
            padding: 30px;
            background: linear-gradient(180deg, #f9fbff 0%, #f6f9ff 100%);
        }

        .input-section {
            background: #ffffff;
            padding: 24px;
            border-radius: 14px;
            margin-bottom: 30px;
            border: 1px solid #e8edff;
            box-shadow: 0 6px 24px rgba(33, 60, 121, 0.08);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #1d2b49;
        }

        input[type="file"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 13px;
            border: 1px solid #d4defa;
            border-radius: 10px;
            font-size: 1em;
            background: #ffffff;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
        }

        input[type="file"] {
            padding: 8px;
            background: #fbfcff;
        }

        input[type="file"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #5e75dd;
            box-shadow: 0 0 0 4px rgba(94, 117, 221, 0.14);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }

        button {
            background: linear-gradient(120deg, #4862d7 0%, #6a58d8 100%);
            color: white;
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
            box-shadow: 0 8px 20px rgba(68, 91, 196, 0.25);
        }

        button:hover {
            transform: translateY(-1px);
            filter: brightness(1.03);
            box-shadow: 0 10px 24px rgba(68, 91, 196, 0.32);
        }

        button:active {
            transform: translateY(0);
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .results.show {
            display: block;
        }

        .summary-box {
            background: #ffffff;
            border-left: 5px solid #5b74df;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e8edff;
            box-shadow: 0 6px 20px rgba(33, 60, 121, 0.08);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            background: #fcfdff;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e5ebff;
            transition: transform 0.18s, box-shadow 0.18s;
        }

        .summary-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(28, 44, 90, 0.1);
        }

        .summary-item-label {
            font-size: 0.9em;
            color: #506083;
            margin-bottom: 5px;
        }

        .summary-item-value {
            font-size: 1.55em;
            font-weight: 700;
            color: #445ec8;
            line-height: 1.2;
        }

        .summary-item-value.negative {
            color: #dc3545;
        }

        .summary-item-value.positive {
            color: #28a745;
        }

        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95em;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e8edff;
        }

        .sales-table thead {
            background: #eef3ff;
            border-bottom: 1px solid #dce6ff;
        }

        .sales-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2f4068;
            font-size: 0.88em;
        }

        .sales-table td {
            padding: 12px;
            border-bottom: 1px solid #edf2ff;
            color: #233356;
        }

        .sales-table tr:hover {
            background: #f7f9ff;
        }

        .method-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .method-badge.actual {
            background: #e3f2fd;
            color: #1976d2;
        }

        .method-badge.deemed {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .guidance {
            background: #fff9e8;
            border-left: 5px solid #f5c247;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #f8e4a2;
        }

        .guidance h3 {
            margin-bottom: 10px;
            color: #856404;
        }

        .guidance ul {
            margin-left: 20px;
            color: #7a5c00;
        }

        .guidance li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .error {
            background: #fff1f2;
            border: 1px solid #ffc9ce;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .export-buttons button {
            flex: 1;
            min-width: 170px;
        }

        .section-title {
            font-size: 1.18rem;
            font-weight: 700;
            color: #1c2b4e;
            margin-bottom: 14px;
            letter-spacing: 0.2px;
        }

        .section-subtitle {
            margin-top: -6px;
            margin-bottom: 16px;
            color: #5f7198;
            font-size: 0.93rem;
        }

        .csv-sample {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.85em;
            overflow-x: auto;
        }

        .help-text {
            font-size: 0.85em;
            color: #607196;
            margin-top: 5px;
            line-height: 1.5;
        }

        .toggle-sales {
            background: linear-gradient(120deg, #4a63d7 0%, #6656d7 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
        }

        .sales-section {
            display: none;
        }

        .sales-section.show {
            display: block;
        }

        .support-creator {
            margin-top: 24px;
            text-align: center;
        }

        .support-creator a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-weight: 600;
            color: #333;
            background: #fff7d6;
            border: 1px solid #f3db8a;
            padding: 11px 15px;
            border-radius: 10px;
            box-shadow: 0 5px 14px rgba(94, 73, 0, 0.12);
        }

        .support-creator a:hover {
            background: #ffefbe;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .sales-table {
                font-size: 0.8em;
            }

            .sales-table th,
            .sales-table td {
                padding: 8px;
            }

            .export-buttons button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Trading 212 Verolaskuri</h1>
            <p>Suomalainen osakkeiden ja ETF:n verolaskenta - FIFO + hankintameno-olettama</p>
        </div>

        <div class="content">
            <div class="input-section">
                <h2 class="section-title">L√§ht√∂tiedot</h2>
                <div class="section-subtitle">T√§yt√§ perustiedot, valitse CSV ja laske verot yhdell√§ klikkauksella.</div>

                <div class="form-group">
                    <label for="formatSelect">CSV-muoto</label>
                    <select id="formatSelect" onchange="updateFormatHelp()">
                        <option value="trading212">Trading 212 (History)</option>
                        <option value="manual">Manuaalinen muoto</option>
                    </select>
                    <div class="help-text">Trading 212: Lataa suoraan "History" CSV:n. Manuaalinen: Oma muoto.</div>
                </div>

                <div class="form-group">
                    <label for="csvFile">Lataa CSV-tiedosto</label>
                    <input type="file" id="csvFile" accept=".csv">
                    <div id="formatHelp"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="taxYear">Verovuosi</label>
                        <input type="number" id="taxYear" value="2025" min="2000" max="2030">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fullName">Nimi</label>
                        <input type="text" id="fullName" placeholder="Esim. Matti Meik√§l√§inen">
                    </div>
                    <div class="form-group">
                        <label for="personalId">Henkil√∂-/Y-tunnus</label>
                        <input type="text" id="personalId" placeholder="Esim. 010101-123A">
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="cashbackTaxFree">
                    <label for="cashbackTaxFree">Cashback on verovapaa minimihyvitys</label>
                </div>

                <button onclick="calculateTaxes()">Laske verot</button>
            </div>

            <div class="error" id="errorMessage"></div>

            <div class="results" id="results">
                <h2 class="section-title">Verovuoden yhteenveto</h2>
                <div class="section-subtitle">Alla yhteenveto sek√§ OmaVeroa varten tarvittavat koontitiedot.</div>

                <div class="summary-box">
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-item-label">Luovutusvoitot</div>
                            <div class="summary-item-value positive" id="totalGains">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Luovutustappiot</div>
                            <div class="summary-item-value negative" id="totalLosses">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Netto luovutusvoitto</div>
                            <div class="summary-item-value" id="netGains">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Osingot (brutto)</div>
                            <div class="summary-item-value" id="dividendGross">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Osingot (veronalainen 85%)</div>
                            <div class="summary-item-value" id="dividendTaxable">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Korkotulot</div>
                            <div class="summary-item-value" id="interestIncome">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Cashback (veronalainen)</div>
                            <div class="summary-item-value" id="cashbackTaxable">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Hoito-/s√§ilytyskulut</div>
                            <div class="summary-item-value" id="custodyFees">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">V√§hennyskelpoiset kulut</div>
                            <div class="summary-item-value" id="deductibleFees">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">P√§√§omatulo yhteens√§</div>
                            <div class="summary-item-value" id="netCapitalIncome">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Arvioitu p√§√§omatuloverot</div>
                            <div class="summary-item-value" id="estimatedTax">0.00 ‚Ç¨</div>
                        </div>
                    </div>
                </div>

                <div class="summary-box">
                    <h3 style="margin-bottom: 12px;">OmaVero-koonti myynneist√§</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-item-label">Voitolliset: myynnit yhteens√§</div>
                            <div class="summary-item-value" id="profitProceedsTotal">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Voitolliset: hankintameno yhteens√§</div>
                            <div class="summary-item-value" id="profitCostTotal">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Voitolliset: voitto yhteens√§</div>
                            <div class="summary-item-value positive" id="profitGainTotal">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Tappiolliset: myynnit yhteens√§</div>
                            <div class="summary-item-value" id="lossProceedsTotal">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Tappiolliset: hankintameno yhteens√§</div>
                            <div class="summary-item-value" id="lossCostTotal">0.00 ‚Ç¨</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-item-label">Tappiolliset: tappio yhteens√§</div>
                            <div class="summary-item-value negative" id="lossGainTotal">0.00 ‚Ç¨</div>
                        </div>
                    </div>
                </div>

                <button class="toggle-sales" onclick="toggleSales()">üìã N√§yt√§/piilota myynnit</button>

                <div class="sales-section" id="salesSection">
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Myynnit (FIFO + hankintameno-olettama)</h3>
                    <table class="sales-table" id="salesTable">
                        <thead>
                            <tr>
                                <th>P√§iv√§</th>
                                <th>Osake</th>
                                <th>M√§√§r√§</th>
                                <th>Myyntihinta</th>
                                <th>Provisio</th>
                                <th>Todellinen hankintameno</th>
                                <th>Olettama hankintameno</th>
                                <th>K√§ytetty menetelm√§</th>
                                <th>Voitto/tappio</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="guidance">
                    <h3>üìå Yleiset ohjeet ilmoittamiseen</h3>
                    <ul>
                        <li><strong>Arvopaperien luovutukset:</strong> Ilmoita luovutusvoitot/-tappiot lomakkeella 9A / OmaVero.</li>
                        <li><strong>Listattujen yhti√∂iden osingot:</strong> Veronalainen osuus t√§ss√§ laskurissa = 85% brutto-osingoista.</li>
                        <li><strong>Korkotulot:</strong> P√§√§omatuloa. Osa koroista voi olla l√§hdeverotuksen piiriss√§ palvelusta riippuen.</li>
                        <li><strong>Hoito- ja s√§ilytysmenot:</strong> Ilmoita kokonaism√§√§r√§; 50 ‚Ç¨ omavastuu huomioidaan verotuksessa.</li>
                        <li><strong>Cashback:</strong> Veronalainen p√§√§omatulo saantihetken k√§yv√§ll√§ arvolla, ellei verovapaa minimihyvitys -poikkeus t√§yty.</li>
                        <li><strong>HUOM:</strong> T√§m√§ ei ole veroneuvontaa. Tarkista lopullinen ilmoittaminen OmaVerosta.</li>
                    </ul>
                </div>

                <div class="export-buttons">
                    <button onclick="exportAsJSON()">üì• Lataa JSON</button>
                    <button onclick="exportAsSellersCSV()">üì• Lataa myynnit CSV:ksi</button>
                    <button onclick="export9APdf()">üìÑ Lataa 9A PDF</button>
                </div>

                <div class="support-creator">
                    <a href="https://buymeacoffee.com/yourname" target="_blank" rel="noopener noreferrer" aria-label="Support creator on Buy Me a Coffee">
                        ‚òï Buy Me a Coffee
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        // ===== Parametrit (tarvittaessa s√§√§d√§) =====
        const CAPITAL_INCOME_BRACKET_EUR = 30_000;
        const CAPITAL_TAX_LOW = 0.30;
        const CAPITAL_TAX_HIGH = 0.34;
        const LISTED_DIVIDEND_TAXABLE_SHARE = 0.85;
        const DEEMED_COST_UNDER_10Y = 0.20;
        const DEEMED_COST_10Y_OR_MORE = 0.40;
        const CUSTODY_DEDUCTIBLE_EXCESS = 50.0;

        // ===== Format help text =====
        function updateFormatHelp() {
            const format = document.getElementById('formatSelect').value;
            const helpDiv = document.getElementById('formatHelp');

            if (format === 'trading212') {
                helpDiv.innerHTML = `
                    <div class="help-text">Vaaditut sarakkeet: Action, Time, Ticker, No. of shares, Gross Total, Currency (Gross Total), Currency conversion fee</div>
                    <div class="csv-sample">
                        <strong>Esimerkki (Trading 212 History):</strong><br>
Action,Time,Ticker,No. of shares,Gross Total,Currency (Gross Total),Currency conversion fee<br>
Market buy,2025-01-15 10:30:00,AAPL,10,1500.00,EUR,0.00<br>
Dividend (AAPL),2025-03-20 00:00:00,AAPL,0,25.00,EUR,0.00<br>
Market sell,2025-06-10 14:22:00,AAPL,5,800.00,EUR,0.00
                    </div>
                `;
            } else {
                helpDiv.innerHTML = `
                    <div class="help-text">Vaaditut sarakkeet: date, type, symbol, qty, price_eur, fee_eur</div>
                    <div class="csv-sample">
                        <strong>Esimerkki (Manuaalinen):</strong><br>
date,type,symbol,qty,price_eur,fee_eur<br>
2025-01-15,BUY,AAPL,10,150.00,5.00<br>
2025-03-20,DIVIDEND,AAPL,0,2.50,0<br>
2025-06-10,SELL,AAPL,5,160.00,5.00
                    </div>
                `;
            }
        }

        // Initialize help text
        updateFormatHelp();

        // ===== Tietorakenteet =====

        class Lot {
            constructor(acquired, qty, costTotal) {
                this.acquired = acquired;
                this.qty = qty;
                this.costTotal = costTotal;
            }

            get unitCost() {
                return this.qty > 0 ? this.costTotal / this.qty : 0;
            }
        }

        class SaleResult {
            constructor(symbol, soldDate, qty, proceedsEur, feesEur, actualCostEur, deemedCostEur, methodUsed, gainEur, lotsUsed) {
                this.symbol = symbol;
                this.soldDate = soldDate;
                this.qty = qty;
                this.proceedsEur = proceedsEur;
                this.feesEur = feesEur;
                this.actualCostEur = actualCostEur;
                this.deemedCostEur = deemedCostEur;
                this.methodUsed = methodUsed;
                this.gainEur = gainEur;
                this.lotsUsed = lotsUsed;
            }
        }

        // ===== FIFO Engine =====

        class FifoBook {
            constructor() {
                this.lots = {};
            }

            getLots(symbol) {
                if (!this.lots[symbol]) {
                    this.lots[symbol] = [];
                }
                return this.lots[symbol];
            }

            buy(symbol, date, qty, totalCostEur) {
                if (qty <= 0) throw new Error(`BUY qty must be > 0 (got ${qty})`);
                this.getLots(symbol).push(new Lot(date, qty, totalCostEur));
            }

            applySplit(symbol, ratio) {
                if (ratio <= 0) throw new Error("split ratio must be > 0");
                for (let lot of this.getLots(symbol)) {
                    lot.qty *= ratio;
                }
            }

            sell(symbol, date, qty, proceedsEur, feeEur) {
                if (qty <= 0) throw new Error(`SELL qty must be > 0 (got ${qty})`);

                const lots = this.getLots(symbol);
                let remaining = qty;
                const lotsUsed = [];
                let actualCost = 0;

                while (remaining > 1e-12) {
                    if (lots.length === 0) {
                        throw new Error(`Not enough lots to sell ${qty} ${symbol} on ${date}. Missing acquisition history.`);
                    }

                    const lot = lots[0];
                    const take = Math.min(lot.qty, remaining);
                    const costPiece = lot.unitCost * take;

                    lotsUsed.push([lot.acquired, take, costPiece]);
                    actualCost += costPiece;

                    lot.qty -= take;
                    lot.costTotal -= costPiece;
                    remaining -= take;

                    if (lot.qty <= 1e-12) {
                        lots.shift();
                    }
                }

                const proceeds = proceedsEur;

                // hankintameno-olettama
                const holdingDaysMin = Math.min(...lotsUsed.map(([acq, _, __]) => 
                    Math.floor((date - acq) / (1000 * 60 * 60 * 24))
                ));
                const deemedRate = holdingDaysMin >= 3650 ? DEEMED_COST_10Y_OR_MORE : DEEMED_COST_UNDER_10Y;
                const deemedCost = proceeds * deemedRate;

                const gainActual = proceeds - actualCost - feeEur;
                const gainDeemed = proceeds - deemedCost;

                let method, gain, costUsed;
                if (gainDeemed < gainActual) {
                    method = "DEEMED";
                    gain = gainDeemed;
                    costUsed = deemedCost;
                } else {
                    method = "ACTUAL";
                    gain = gainActual;
                    costUsed = actualCost + feeEur;
                }

                return new SaleResult(
                    symbol,
                    date,
                    qty,
                    proceeds,
                    feeEur,
                    actualCost + feeEur,
                    deemedCost,
                    method,
                    gain,
                    lotsUsed
                );
            }
        }

        // ===== Laskenta =====

        function estimateCapitalTax(netCapitalIncome) {
            if (netCapitalIncome <= 0) return 0;
            const low = Math.min(netCapitalIncome, CAPITAL_INCOME_BRACKET_EUR);
            const high = Math.max(0, netCapitalIncome - CAPITAL_INCOME_BRACKET_EUR);
            return low * CAPITAL_TAX_LOW + high * CAPITAL_TAX_HIGH;
        }

        function parseDate(dateString) {
            return new Date(dateString);
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('fi-FI', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('fi-FI', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function getSaleCostUsed(sale) {
            return sale.methodUsed === 'DEEMED' ? sale.deemedCostEur : sale.actualCostEur;
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(',');
                const row = {};
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j]] = values[j] ? values[j].trim() : '';
                }
                rows.push(row);
            }

            return rows;
        }

        function parseTrading212(rows) {
            const requiredColumns = ['action', 'time', 'ticker', 'no. of shares', 'gross total', 'currency (gross total)', 'currency conversion fee'];
            if (rows.length === 0) throw new Error('CSV-tiedosto on tyhj√§');

            const firstRow = rows[0];
            const missingCols = requiredColumns.filter(col => !(col in firstRow));
            if (missingCols.length > 0) {
                const detectedFormat = autoDetectFormat(rows);
                if (detectedFormat !== 'trading212') {
                    throw new Error(`V√§√§r√§ muoto! CSV n√§ytt√§√§ olevan manuaalinen muoto. Valitse "Manuaalinen muoto" dropdown-valikosta.`);
                }
                throw new Error(`Sarakkeet puuttuvat CSV:st√§: ${missingCols.join(', ')}`);
            }

            const transactions = [];
            for (let row of rows) {
                const action = row['action'].trim().toLowerCase();
                const timeStr = row['time'].trim();
                const ticker = row['ticker'].trim().toUpperCase();
                const qty = parseFloat(row['no. of shares']) || 0;
                const grossTotal = parseFloat(row['gross total']) || 0;
                const fxFee = parseFloat(row['currency conversion fee']) || 0;

                const date = parseDate(timeStr.split(' ')[0]); // Extract just the date part

                let type = 'IGNORE';
                if (action.includes('market buy') || action.includes('limit buy') || action.match(/\bbuy\b/)) {
                    type = 'BUY';
                } else if (action.includes('market sell') || action.includes('limit sell') || action.match(/\bsell\b/)) {
                    type = 'SELL';
                } else if (action.includes('interest on cash')) {
                    type = 'INTEREST';
                } else if (action.includes('dividend')) {
                    type = 'DIVIDEND';
                }

                if (type !== 'IGNORE') {
                    transactions.push({
                        date: date,
                        type: type,
                        symbol: ticker || 'CASH',
                        qty: qty,
                        gross_total_eur: Math.abs(grossTotal),
                        fx_fee_eur: Math.abs(fxFee)
                    });
                }
            }

            return transactions.sort((a, b) => a.date - b.date);
        }

        function autoDetectFormat(rows) {
            if (rows.length === 0) throw new Error('CSV-tiedosto on tyhj√§');
            
            const firstRow = rows[0];
            const columns = Object.keys(firstRow);
            
            // Check for Trading 212 format
            const trading212Required = ['action', 'time', 'ticker', 'no. of shares', 'gross total', 'currency (gross total)', 'currency conversion fee'];
            const hasTrading212 = trading212Required.every(col => columns.includes(col));
            
            // Check for manual format
            const manualRequired = ['date', 'type', 'symbol', 'qty', 'price_eur', 'fee_eur'];
            const hasManual = manualRequired.every(col => columns.includes(col));
            
            if (hasTrading212) {
                return 'trading212';
            } else if (hasManual) {
                return 'manual';
            } else {
                throw new Error(`CSV-muotoa ei tunnistettu. L√∂ydetyt sarakkeet: ${columns.join(', ')}`);
            }
        }

        function parseManual(rows) {
            const requiredColumns = ['date', 'type', 'symbol', 'qty', 'price_eur', 'fee_eur'];
            if (rows.length === 0) throw new Error('CSV-tiedosto on tyhj√§');

            const firstRow = rows[0];
            const missingCols = requiredColumns.filter(col => !(col in firstRow));
            if (missingCols.length > 0) {
                const detectedFormat = autoDetectFormat(rows);
                if (detectedFormat !== 'manual') {
                    throw new Error(`V√§√§r√§ muoto! CSV n√§ytt√§√§ olevan ${detectedFormat === 'trading212' ? 'Trading 212' : 'tuntematon'} -muodossa. Valitse oikea muoto dropdown-valikosta.`);
                }
                throw new Error(`Sarakkeet puuttuvat CSV:st√§: ${missingCols.join(', ')}`);
            }

            const transactions = [];
            for (let row of rows) {
                const date = parseDate(row['date'].trim());
                const type = row['type'].trim().toUpperCase();
                const symbol = row['symbol'].trim().toUpperCase();
                const qty = parseFloat(row['qty']) || 0;
                const priceEur = parseFloat(row['price_eur']) || 0;
                const feeEur = parseFloat(row['fee_eur']) || 0;

                transactions.push({
                    date: date,
                    type: type,
                    symbol: symbol,
                    qty: qty,
                    price_eur: priceEur,
                    fee_eur: feeEur
                });
            }

            return transactions.sort((a, b) => a.date - b.date);
        }

        function calculateTaxes() {
            const errorElement = document.getElementById('errorMessage');
            errorElement.classList.remove('show');
            errorElement.textContent = '';

            try {
                const fileInput = document.getElementById('csvFile');
                if (!fileInput.files.length) {
                    throw new Error('Valitse CSV-tiedosto');
                }

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        const rows = parseCSV(csvText);
                        const year = parseInt(document.getElementById('taxYear').value);
                        const cashbackTaxFree = document.getElementById('cashbackTaxFree').checked;
                        let format = document.getElementById('formatSelect').value;

                        // Auto-detect format if possible
                        try {
                            const detectedFormat = autoDetectFormat(rows);
                            if (format !== detectedFormat && detectedFormat !== null) {
                                console.log(`Auto-detected format: ${detectedFormat}, using that instead of selected: ${format}`);
                                format = detectedFormat;
                                document.getElementById('formatSelect').value = format;
                            }
                        } catch (e) {
                            // Auto-detection failed, continue with selected format
                        }

                        // Parse based on format
                        let transactions;
                        if (format === 'trading212') {
                            transactions = parseTrading212(rows);
                        } else {
                            transactions = parseManual(rows);
                        }

                        // Process transactions
                        const book = new FifoBook();
                        const sales = [];

                        let dividendsGross = 0;
                        let dividendsTaxable = 0;
                        let interestIncome = 0;
                        let cashbackTaxable = 0;
                        let custodyFees = 0;

                        for (let transaction of transactions) {
                            const d = transaction.date;
                            const type = transaction.type;
                            const symbol = transaction.symbol;
                            const qty = transaction.qty;

                            if (type === 'BUY') {
                                let totalCost;
                                if (format === 'trading212') {
                                    totalCost = transaction.gross_total_eur + transaction.fx_fee_eur;
                                } else {
                                    totalCost = qty * transaction.price_eur + transaction.fee_eur;
                                }
                                book.buy(symbol, d, qty, totalCost);

                            } else if (type === 'SELL') {
                                let proceedsEur, feesEur;
                                if (format === 'trading212') {
                                    proceedsEur = transaction.gross_total_eur;
                                    feesEur = transaction.fx_fee_eur;
                                } else {
                                    proceedsEur = qty * transaction.price_eur;
                                    feesEur = transaction.fee_eur;
                                }
                                const res = book.sell(symbol, d, qty, proceedsEur, feesEur);
                                if (d.getFullYear() === year) {
                                    sales.push(res);
                                }

                            } else if (type === 'SPLIT' && format === 'manual') {
                                // qty field contains the split ratio
                                book.applySplit(symbol, qty);

                            } else if (type === 'REVERSE_SPLIT' && format === 'manual') {
                                // qty field contains the reverse split ratio
                                book.applySplit(symbol, qty);

                            } else if (type === 'DIVIDEND') {
                                if (d.getFullYear() === year) {
                                    const gross = format === 'trading212' ? transaction.gross_total_eur : transaction.price_eur;
                                    dividendsGross += gross;
                                    dividendsTaxable += gross * LISTED_DIVIDEND_TAXABLE_SHARE;
                                }

                            } else if (type === 'INTEREST') {
                                if (d.getFullYear() === year) {
                                    const amount = format === 'trading212' ? transaction.gross_total_eur : transaction.price_eur;
                                    interestIncome += amount;
                                }

                            } else if ((type === 'CUSTODY_FEE' || type === 'FEE') && format === 'manual') {
                                if (d.getFullYear() === year) {
                                    custodyFees += transaction.fee_eur;
                                }

                            } else if (type === 'CASHBACK' && format === 'manual') {
                                if (d.getFullYear() === year) {
                                    if (!cashbackTaxFree) {
                                        cashbackTaxable += transaction.price_eur;
                                    }
                                }
                            }
                        }

                        // Calculate results
                        const totalGains = sales.reduce((sum, s) => sum + (s.gainEur > 0 ? s.gainEur : 0), 0);
                        const totalLosses = sales.reduce((sum, s) => sum + (s.gainEur < 0 ? s.gainEur : 0), 0);
                        const netGains = totalGains + totalLosses;

                        const profitableSales = sales.filter(s => s.gainEur > 0);
                        const lossSales = sales.filter(s => s.gainEur < 0);

                        const profitProceedsTotal = profitableSales.reduce((sum, s) => sum + s.proceedsEur, 0);
                        const profitCostTotal = profitableSales.reduce((sum, s) => sum + getSaleCostUsed(s), 0);
                        const profitGainTotal = profitableSales.reduce((sum, s) => sum + s.gainEur, 0);

                        const lossProceedsTotal = lossSales.reduce((sum, s) => sum + s.proceedsEur, 0);
                        const lossCostTotal = lossSales.reduce((sum, s) => sum + getSaleCostUsed(s), 0);
                        const lossGainTotal = lossSales.reduce((sum, s) => sum + s.gainEur, 0);

                        const custodyDeductible = Math.max(0, custodyFees - CUSTODY_DEDUCTIBLE_EXCESS);
                        const netCapitalIncome = netGains + dividendsTaxable + interestIncome + cashbackTaxable - custodyDeductible;
                        const estimatedTax = estimateCapitalTax(netCapitalIncome);

                        // Update display
                        document.getElementById('totalGains').textContent = formatCurrency(totalGains);
                        document.getElementById('totalGains').className = 'summary-item-value positive';

                        document.getElementById('totalLosses').textContent = formatCurrency(totalLosses);
                        document.getElementById('totalLosses').className = totalLosses < 0 ? 'summary-item-value negative' : 'summary-item-value';

                        document.getElementById('netGains').textContent = formatCurrency(netGains);
                        document.getElementById('netGains').className = netGains >= 0 ? 'summary-item-value positive' : 'summary-item-value negative';

                        document.getElementById('dividendGross').textContent = formatCurrency(dividendsGross);
                        document.getElementById('dividendTaxable').textContent = formatCurrency(dividendsTaxable);
                        document.getElementById('interestIncome').textContent = formatCurrency(interestIncome);
                        document.getElementById('cashbackTaxable').textContent = formatCurrency(cashbackTaxable);
                        document.getElementById('custodyFees').textContent = formatCurrency(custodyFees);
                        document.getElementById('deductibleFees').textContent = formatCurrency(custodyDeductible);

                        document.getElementById('netCapitalIncome').textContent = formatCurrency(netCapitalIncome);
                        document.getElementById('netCapitalIncome').className = netCapitalIncome >= 0 ? 'summary-item-value positive' : 'summary-item-value negative';

                        document.getElementById('estimatedTax').textContent = formatCurrency(estimatedTax);
                        document.getElementById('estimatedTax').className = 'summary-item-value';

                        document.getElementById('profitProceedsTotal').textContent = formatCurrency(profitProceedsTotal);
                        document.getElementById('profitCostTotal').textContent = formatCurrency(profitCostTotal);
                        document.getElementById('profitGainTotal').textContent = formatCurrency(profitGainTotal);
                        document.getElementById('profitGainTotal').className = 'summary-item-value positive';

                        document.getElementById('lossProceedsTotal').textContent = formatCurrency(lossProceedsTotal);
                        document.getElementById('lossCostTotal').textContent = formatCurrency(lossCostTotal);
                        document.getElementById('lossGainTotal').textContent = formatCurrency(lossGainTotal);
                        document.getElementById('lossGainTotal').className = 'summary-item-value negative';

                        // Update sales table
                        const tbody = document.querySelector('#salesTable tbody');
                        tbody.innerHTML = '';

                        for (let sale of sales.sort((a, b) => a.soldDate - b.soldDate)) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${sale.soldDate.toLocaleDateString('fi-FI')}</td>
                                <td>${sale.symbol}</td>
                                <td>${formatNumber(sale.qty)}</td>
                                <td>${formatCurrency(sale.proceedsEur)}</td>
                                <td>${formatCurrency(sale.feesEur)}</td>
                                <td>${formatCurrency(sale.actualCostEur)}</td>
                                <td>${formatCurrency(sale.deemedCostEur)}</td>
                                <td><span class="method-badge ${sale.methodUsed === 'ACTUAL' ? 'actual' : 'deemed'}">${sale.methodUsed}</span></td>
                                <td>${formatCurrency(sale.gainEur)}</td>
                            `;
                            tbody.appendChild(row);
                        }

                        // Save results for export
                        window.lastResults = {
                            year: year,
                            totalGains: totalGains,
                            totalLosses: totalLosses,
                            netGains: netGains,
                            dividendsGross: dividendsGross,
                            dividendsTaxable: dividendsTaxable,
                            interestIncome: interestIncome,
                            cashbackTaxable: cashbackTaxable,
                            custodyFees: custodyFees,
                            custodyDeductible: custodyDeductible,
                            netCapitalIncome: netCapitalIncome,
                            estimatedTax: estimatedTax,
                            omaVeroSummary: {
                                profitable: {
                                    proceedsTotal: profitProceedsTotal,
                                    costTotal: profitCostTotal,
                                    gainTotal: profitGainTotal
                                },
                                lossMaking: {
                                    proceedsTotal: lossProceedsTotal,
                                    costTotal: lossCostTotal,
                                    gainTotal: lossGainTotal
                                }
                            },
                            sales: sales
                        };

                        // Show results
                        document.getElementById('results').classList.add('show');

                    } catch (error) {
                        errorElement.textContent = `Virhe: ${error.message}`;
                        errorElement.classList.add('show');
                    }
                };

                reader.readAsText(file);

            } catch (error) {
                errorElement.textContent = `Virhe: ${error.message}`;
                errorElement.classList.add('show');
            }
        }

        function toggleSales() {
            document.getElementById('salesSection').classList.toggle('show');
        }

        function exportAsJSON() {
            if (!window.lastResults) {
                alert('Laske ensin verot');
                return;
            }

            const data = JSON.stringify(window.lastResults, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `verolaskuri_${window.lastResults.year}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportAsSellersCSV() {
            if (!window.lastResults || !window.lastResults.sales.length) {
                alert('Ei myyntej√§ exporttia varten');
                return;
            }

            let csv = 'P√§iv√§,Osake,M√§√§r√§,Myyntihinta,Provisio,Todellinen hankintameno,Olettama hankintameno,Menetelm√§,Voitto/tappio\n';

            for (let sale of window.lastResults.sales) {
                csv += [
                    sale.soldDate.toLocaleDateString('fi-FI'),
                    sale.symbol,
                    formatNumber(sale.qty).replace(',', '.'),
                    formatNumber(sale.proceedsEur).replace(',', '.'),
                    formatNumber(sale.feesEur).replace(',', '.'),
                    formatNumber(sale.actualCostEur).replace(',', '.'),
                    formatNumber(sale.deemedCostEur).replace(',', '.'),
                    sale.methodUsed,
                    formatNumber(sale.gainEur).replace(',', '.')
                ].join(',') + '\n';
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `myynnit_${window.lastResults.year}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function export9APdf() {
            if (!window.lastResults) {
                alert('Laske ensin verot');
                return;
            }

            if (!window.jspdf || !window.jspdf.jsPDF) {
                alert('PDF-kirjasto ei latautunut. Yrit√§ p√§ivitt√§√§ sivu ja kokeile uudelleen.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const margin = 40;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let y = margin;

            const results = window.lastResults;
            const sales = [...(results.sales || [])].sort((a, b) => a.soldDate - b.soldDate);
            const summary = results.omaVeroSummary || {
                profitable: { proceedsTotal: 0, costTotal: 0, gainTotal: 0 },
                lossMaking: { proceedsTotal: 0, costTotal: 0, gainTotal: 0 }
            };
            const fullName = (document.getElementById('fullName')?.value || '').trim() || '-';
            const personalId = (document.getElementById('personalId')?.value || '').trim() || '-';
            const periodText = `1.1.${results.year} - 31.12.${results.year}`;

            const euro = (v) => `${Number(v || 0).toFixed(2)} ‚Ç¨`;
            const toDate = (d) => {
                if (d instanceof Date) return d.toLocaleDateString('fi-FI');
                return new Date(d).toLocaleDateString('fi-FI');
            };
            const costUsed = (s) => (s.methodUsed === 'DEEMED' ? s.deemedCostEur : s.actualCostEur);

            function addHeader() {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text('9A-liite (arvopaperien luovutukset)', margin, y);
                y += 22;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                doc.text(`Nimi: ${fullName}`, margin, y);
                y += 14;
                doc.text(`Henkil√∂-/Y-tunnus: ${personalId}`, margin, y);
                y += 14;
                doc.text(`Period: ${periodText}`, margin, y);
                y += 14;
                doc.text('Koonti OmaVeroa varten: voitolliset ja tappiolliset myynnit erikseen.', margin, y);
                y += 18;

                doc.setDrawColor(210);
                doc.line(margin, y, pageWidth - margin, y);
                y += 16;
            }

            function ensureSpace(requiredHeight) {
                if (y + requiredHeight <= pageHeight - margin) return;
                doc.addPage();
                y = margin;
                addHeader();
            }

            function writeSummaryLine(label, proceeds, cost, gain, gainLabel) {
                ensureSpace(18);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(label, margin, y);
                y += 14;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(`Myynnit yht.: ${euro(proceeds)}`, margin + 12, y);
                doc.text(`Hankintameno yht.: ${euro(cost)}`, margin + 190, y);
                doc.text(`${gainLabel}: ${euro(gain)}`, margin + 410, y);
                y += 16;
            }

            addHeader();

            writeSummaryLine(
                'Voitolliset myynnit',
                summary.profitable.proceedsTotal,
                summary.profitable.costTotal,
                summary.profitable.gainTotal,
                'Voitto yht.'
            );
            writeSummaryLine(
                'Tappiolliset myynnit',
                summary.lossMaking.proceedsTotal,
                summary.lossMaking.costTotal,
                summary.lossMaking.gainTotal,
                'Tappio yht.'
            );

            ensureSpace(30);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('Myyntikohtaiset rivit', margin, y);
            y += 14;

            const cols = {
                date: margin,
                symbol: margin + 72,
                qty: margin + 132,
                proceeds: margin + 190,
                cost: margin + 295,
                method: margin + 405,
                gain: margin + 475,
            };

            function drawTableHeader() {
                ensureSpace(22);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('P√§iv√§', cols.date, y);
                doc.text('Arvopaperi', cols.symbol, y);
                doc.text('M√§√§r√§', cols.qty, y);
                doc.text('Myynti', cols.proceeds, y);
                doc.text('Hankintameno', cols.cost, y);
                doc.text('Menetelm√§', cols.method, y);
                doc.text('Voitto/tappio', cols.gain, y);
                y += 8;
                doc.setDrawColor(180);
                doc.line(margin, y, pageWidth - margin, y);
                y += 12;
            }

            drawTableHeader();

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            for (const s of sales) {
                ensureSpace(16);
                if (y > pageHeight - margin - 20) {
                    doc.addPage();
                    y = margin;
                    addHeader();
                    drawTableHeader();
                }

                doc.text(toDate(s.soldDate), cols.date, y);
                doc.text(String(s.symbol || ''), cols.symbol, y);
                doc.text(Number(s.qty || 0).toFixed(2), cols.qty, y);
                doc.text(Number(s.proceedsEur || 0).toFixed(2), cols.proceeds, y);
                doc.text(Number(costUsed(s) || 0).toFixed(2), cols.cost, y);
                doc.text(String(s.methodUsed || ''), cols.method, y);
                doc.text(Number(s.gainEur || 0).toFixed(2), cols.gain, y);
                y += 13;
            }

            ensureSpace(30);
            y += 8;
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(9);
            doc.text('Huom: Tarkista tiedot ennen OmaVeroon ilmoittamista.', margin, y);

            doc.save(`9A_liite_${results.year}.pdf`);
        }

        // Keyboard shortcut: Enter to calculate
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                calculateTaxes();
            }
        });
    </script>
</body>
</html>
